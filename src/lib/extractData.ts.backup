import { Answer } from './types';

export function getAnswerValue(
  answers: Answer[],
  blockCode: string,
  questionCode: string,
  defaultValue: any = 0
): any {
  const answer = answers.find(
    (a) => a.block_code === blockCode && a.question_code === questionCode
  );
  return answer?.value ?? defaultValue;
}

export interface ExtractedFinanceData {
  revenus: {
    ca_abonnements_mensuels: number;
    ca_abonnements_trimestriels: number;
    ca_abonnements_semestriels: number;
    ca_abonnements_annuels: number;
    ca_cartes_10: number;
    ca_cartes_20: number;
    ca_seances_unitaires: number;
    ca_frais_inscription: number;
    ca_personal_training: number;
    ca_coaching_nutrition: number;
    ca_suivi_remote: number;
    ca_cours_specialises: number;
    ca_competitions_internes: number;
    ca_competitions_externes: number;
    ca_seminaires: number;
    ca_team_building: number;
    ca_merchandising_vetements: number;
    ca_merchandising_accessoires: number;
    ca_complements: number;
    ca_boissons_snacks: number;
    ca_sous_location: number;
    ca_partenariats: number;
    ca_sponsoring: number;

    ca_total: number;
    ca_recurrent: number;
    ca_non_recurrent: number;
    pourcent_recurrent: number;
  };

  charges: {
    achats_marchandises: number;
    variation_stock: number;
    achats_fournitures: number;

    loyer_mensuel_ht: number;
    charges_locatives_mensuelles: number;
    taxe_fonciere: number;
    loyer_annuel_total: number;

    electricite_annuel: number;
    eau_annuel: number;
    gaz_chauffage_annuel: number;
    energies_total: number;

    entretien_locaux: number;
    entretien_materiel: number;
    reparations_exceptionnelles: number;
    entretien_total: number;

    assurance_rc_pro: number;
    assurance_locaux: number;
    assurance_materiel: number;
    assurance_prevoyance: number;
    mutuelle_entreprise: number;
    assurances_total: number;

    honoraires_comptable: number;
    honoraires_avocat: number;
    cotisations_professionnelles: number;
    affiliation_crossfit_annuel: number;
    licences_federales: number;
    autres_honoraires: number;
    services_exterieurs_total: number;

    telephone_internet: number;
    frais_postaux: number;
    logiciel_planning: number;
    logiciel_compta: number;
    logiciel_crm: number;
    autres_logiciels: number;
    site_web_hebergement: number;
    communication_total: number;

    google_ads: number;
    facebook_instagram_ads: number;
    flyers_affiches: number;
    marketing_influence: number;
    sponsoring_events: number;
    autres_marketing: number;
    marketing_total: number;

    salaires_bruts_gerant: number;
    salaires_bruts_coachs: number;
    salaires_bruts_administratif: number;
    charges_sociales_patronales: number;
    tickets_restaurant: number;
    formations_salaries: number;
    medecine_travail: number;
    charges_freelance: number;
    autres_charges_personnel: number;
    masse_salariale_total: number;

    impots_taxes: number;
    cfe: number;
    autres_impots: number;
    impots_total: number;

    interets_emprunt: number;
    agios_bancaires: number;
    frais_financiers_total: number;

    amortissements: number;
    provisions: number;
    autres_charges_fixes: number;

    charges_total: number;
  };

  resultat: {
    ebitda: number;
    ebitda_avant_amortissements: number;
    marge_ebitda: number;
    resultat_net: number;
    marge_nette: number;
  };

  ratios: {
    loyer_ca_ratio: number;
    ms_ca_ratio: number;
    marketing_ca_ratio: number;
    charges_ca_ratio: number;
  };
}

export function extractFinanceData(answers: Answer[]): ExtractedFinanceData {
  const ca_abonnements_mensuels = getAnswerValue(answers, 'produits_exploitation', 'ca_abonnements_mensuels', 0);
  const ca_abonnements_trimestriels = getAnswerValue(answers, 'produits_exploitation', 'ca_abonnements_trimestriels', 0);
  const ca_abonnements_semestriels = getAnswerValue(answers, 'produits_exploitation', 'ca_abonnements_semestriels', 0);
  const ca_abonnements_annuels = getAnswerValue(answers, 'produits_exploitation', 'ca_abonnements_annuels', 0);
  const ca_cartes_10 = getAnswerValue(answers, 'produits_exploitation', 'ca_cartes_10', 0);
  const ca_cartes_20 = getAnswerValue(answers, 'produits_exploitation', 'ca_cartes_20', 0);
  const ca_seances_unitaires = getAnswerValue(answers, 'produits_exploitation', 'ca_seances_unitaires', 0);
  const ca_frais_inscription = getAnswerValue(answers, 'produits_exploitation', 'ca_frais_inscription', 0);
  const ca_personal_training = getAnswerValue(answers, 'produits_exploitation', 'ca_personal_training', 0);
  const ca_coaching_nutrition = getAnswerValue(answers, 'produits_exploitation', 'ca_coaching_nutrition', 0);
  const ca_suivi_remote = getAnswerValue(answers, 'produits_exploitation', 'ca_suivi_remote', 0);
  const ca_cours_specialises = getAnswerValue(answers, 'produits_exploitation', 'ca_cours_specialises', 0);
  const ca_competitions_internes = getAnswerValue(answers, 'produits_exploitation', 'ca_competitions_internes', 0);
  const ca_competitions_externes = getAnswerValue(answers, 'produits_exploitation', 'ca_competitions_externes', 0);
  const ca_seminaires = getAnswerValue(answers, 'produits_exploitation', 'ca_seminaires', 0);
  const ca_team_building = getAnswerValue(answers, 'produits_exploitation', 'ca_team_building', 0);
  const ca_merchandising_vetements = getAnswerValue(answers, 'produits_exploitation', 'ca_merchandising_vetements', 0);
  const ca_merchandising_accessoires = getAnswerValue(answers, 'produits_exploitation', 'ca_merchandising_accessoires', 0);
  const ca_complements = getAnswerValue(answers, 'produits_exploitation', 'ca_complements', 0);
  const ca_boissons_snacks = getAnswerValue(answers, 'produits_exploitation', 'ca_boissons_snacks', 0);
  const ca_sous_location = getAnswerValue(answers, 'produits_exploitation', 'ca_sous_location', 0);
  const ca_partenariats = getAnswerValue(answers, 'produits_exploitation', 'ca_partenariats', 0);
  const ca_sponsoring = getAnswerValue(answers, 'produits_exploitation', 'ca_sponsoring', 0);

  const ca_recurrent = ca_abonnements_mensuels + ca_abonnements_trimestriels +
                       ca_abonnements_semestriels + ca_abonnements_annuels;

  const ca_non_recurrent = ca_cartes_10 + ca_cartes_20 + ca_seances_unitaires +
                           ca_frais_inscription + ca_personal_training + ca_coaching_nutrition +
                           ca_suivi_remote + ca_cours_specialises + ca_competitions_internes +
                           ca_competitions_externes + ca_seminaires + ca_team_building +
                           ca_merchandising_vetements + ca_merchandising_accessoires +
                           ca_complements + ca_boissons_snacks +
                           ca_sous_location + ca_partenariats + ca_sponsoring;

  const ca_total = ca_recurrent + ca_non_recurrent;
  const pourcent_recurrent = ca_total > 0 ? (ca_recurrent / ca_total) * 100 : 0;

  const achats_marchandises = getAnswerValue(answers, 'charges_exploitation', 'achats_marchandises', 0);
  const variation_stock = getAnswerValue(answers, 'charges_exploitation', 'variation_stock', 0);
  const achats_fournitures = getAnswerValue(answers, 'charges_exploitation', 'achats_fournitures', 0);

  const loyer_mensuel_ht = getAnswerValue(answers, 'charges_exploitation', 'loyer_mensuel_ht', 0);
  const charges_locatives_mensuelles = getAnswerValue(answers, 'charges_exploitation', 'charges_locatives_mensuelles', 0);
  const taxe_fonciere = getAnswerValue(answers, 'charges_exploitation', 'taxe_fonciere', 0);
  const loyer_annuel_total = (loyer_mensuel_ht + charges_locatives_mensuelles) * 12 + taxe_fonciere;

  const electricite_annuel = getAnswerValue(answers, 'charges_exploitation', 'electricite_annuel', 0);
  const eau_annuel = getAnswerValue(answers, 'charges_exploitation', 'eau_annuel', 0);
  const gaz_chauffage_annuel = getAnswerValue(answers, 'charges_exploitation', 'gaz_chauffage_annuel', 0);
  const energies_total = electricite_annuel + eau_annuel + gaz_chauffage_annuel;

  const entretien_locaux = getAnswerValue(answers, 'charges_exploitation', 'entretien_locaux', 0);
  const entretien_materiel = getAnswerValue(answers, 'charges_exploitation', 'entretien_materiel', 0);
  const reparations_exceptionnelles = getAnswerValue(answers, 'charges_exploitation', 'reparations_exceptionnelles', 0);
  const entretien_total = entretien_locaux + entretien_materiel + reparations_exceptionnelles;

  const assurance_rc_pro = getAnswerValue(answers, 'charges_exploitation', 'assurance_rc_pro', 0);
  const assurance_locaux = getAnswerValue(answers, 'charges_exploitation', 'assurance_locaux', 0);
  const assurance_materiel = getAnswerValue(answers, 'charges_exploitation', 'assurance_materiel', 0);
  const assurance_prevoyance = getAnswerValue(answers, 'charges_exploitation', 'assurance_prevoyance', 0);
  const mutuelle_entreprise = getAnswerValue(answers, 'charges_exploitation', 'mutuelle_entreprise', 0);
  const assurances_total = assurance_rc_pro + assurance_locaux + assurance_materiel +
                           assurance_prevoyance + mutuelle_entreprise;

  const honoraires_comptable = getAnswerValue(answers, 'charges_exploitation', 'honoraires_comptable', 0);
  const honoraires_avocat = getAnswerValue(answers, 'charges_exploitation', 'honoraires_avocat', 0);
  const cotisations_professionnelles = getAnswerValue(answers, 'charges_exploitation', 'cotisations_professionnelles', 0);
  const affiliation_crossfit_annuel = getAnswerValue(answers, 'charges_exploitation', 'affiliation_crossfit_annuel', 0);
  const licences_federales = getAnswerValue(answers, 'charges_exploitation', 'licences_federales', 0);
  const autres_honoraires = getAnswerValue(answers, 'charges_exploitation', 'autres_services_exterieurs', 0);
  const services_exterieurs_total = honoraires_comptable + honoraires_avocat + cotisations_professionnelles +
                                    affiliation_crossfit_annuel + licences_federales + autres_honoraires;

  const telephone_internet = getAnswerValue(answers, 'charges_exploitation', 'telephone_internet', 0);
  const frais_postaux = getAnswerValue(answers, 'charges_exploitation', 'frais_postaux', 0);
  const logiciel_planning = getAnswerValue(answers, 'charges_exploitation', 'logiciel_planning', 0);
  const logiciel_compta = getAnswerValue(answers, 'charges_exploitation', 'logiciel_comptabilite', 0);
  const logiciel_crm = getAnswerValue(answers, 'charges_exploitation', 'crm', 0);
  const autres_logiciels = getAnswerValue(answers, 'charges_exploitation', 'autres_logiciels', 0);
  const site_web_hebergement = getAnswerValue(answers, 'charges_exploitation', 'site_web_hebergement', 0);
  const communication_total = telephone_internet + frais_postaux + logiciel_planning + logiciel_compta +
                              logiciel_crm + autres_logiciels + site_web_hebergement;

  const google_ads = getAnswerValue(answers, 'charges_exploitation', 'google_ads', 0);
  const facebook_instagram_ads = getAnswerValue(answers, 'charges_exploitation', 'facebook_instagram_ads', 0);
  const flyers_affiches = getAnswerValue(answers, 'charges_exploitation', 'publicite_locale', 0);
  const marketing_influence = getAnswerValue(answers, 'charges_exploitation', 'creation_graphique', 0);
  const sponsoring_events = getAnswerValue(answers, 'charges_exploitation', 'evenements_marketing', 0);
  const autres_marketing = getAnswerValue(answers, 'charges_exploitation', 'cadeaux_clients', 0);
  const marketing_total = google_ads + facebook_instagram_ads + flyers_affiches +
                          marketing_influence + sponsoring_events + autres_marketing;

  const salaires_bruts_gerant = getAnswerValue(answers, 'charges_exploitation', 'salaires_bruts_gerant', 0);
  const salaires_bruts_coachs = getAnswerValue(answers, 'charges_exploitation', 'salaires_bruts_coachs', 0);
  const salaires_bruts_administratif = getAnswerValue(answers, 'charges_exploitation', 'salaires_bruts_administratif', 0);
  const charges_sociales_patronales = getAnswerValue(answers, 'charges_exploitation', 'charges_sociales_patronales', 0);
  const tickets_restaurant = getAnswerValue(answers, 'charges_exploitation', 'tickets_restaurant', 0);
  const formations_salaries = getAnswerValue(answers, 'charges_exploitation', 'formation_personnel', 0);
  const medecine_travail = getAnswerValue(answers, 'charges_exploitation', 'medecine_travail', 0);
  const charges_freelance = getAnswerValue(answers, 'charges_exploitation', 'charges_freelance', 0);
  const autres_charges_personnel = getAnswerValue(answers, 'charges_exploitation', 'autres_charges_personnel', 0);
  const masse_salariale_total = salaires_bruts_gerant + salaires_bruts_coachs + salaires_bruts_administratif +
                                charges_sociales_patronales + tickets_restaurant + formations_salaries +
                                medecine_travail + charges_freelance + autres_charges_personnel;

  const impots_taxes = getAnswerValue(answers, 'charges_exploitation', 'impots_taxes', 0);
  const cfe = getAnswerValue(answers, 'charges_exploitation', 'cfe', 0);
  const autres_impots = getAnswerValue(answers, 'charges_exploitation', 'autres_impots_taxes', 0);
  const impots_total = impots_taxes + cfe + autres_impots;

  const interets_emprunt = getAnswerValue(answers, 'charges_exploitation', 'interets_emprunts', 0);
  const agios_bancaires = getAnswerValue(answers, 'charges_exploitation', 'frais_bancaires', 0);
  const frais_financiers_total = interets_emprunt + agios_bancaires;

  const amortissements = getAnswerValue(answers, 'charges_exploitation', 'amortissements', 0);
  const provisions = getAnswerValue(answers, 'charges_exploitation', 'provisions', 0);
  const autres_charges_fixes = getAnswerValue(answers, 'charges_exploitation', 'autres_charges_fixes', 0);

  const charges_total = achats_marchandises + variation_stock + achats_fournitures +
                        loyer_annuel_total + energies_total + entretien_total +
                        assurances_total + services_exterieurs_total + communication_total +
                        marketing_total + masse_salariale_total + impots_total +
                        frais_financiers_total + amortissements + provisions + autres_charges_fixes;

  const ebitda = ca_total - (charges_total - amortissements - provisions - frais_financiers_total);
  const ebitda_avant_amortissements = ebitda;
  const marge_ebitda = ca_total > 0 ? (ebitda / ca_total) * 100 : 0;

  const resultat_net = ca_total - charges_total;
  const marge_nette = ca_total > 0 ? (resultat_net / ca_total) * 100 : 0;

  const loyer_ca_ratio = ca_total > 0 ? (loyer_annuel_total / ca_total) * 100 : 0;
  const ms_ca_ratio = ca_total > 0 ? (masse_salariale_total / ca_total) * 100 : 0;
  const marketing_ca_ratio = ca_total > 0 ? (marketing_total / ca_total) * 100 : 0;
  const charges_ca_ratio = ca_total > 0 ? (charges_total / ca_total) * 100 : 0;

  return {
    revenus: {
      ca_abonnements_mensuels,
      ca_abonnements_trimestriels,
      ca_abonnements_semestriels,
      ca_abonnements_annuels,
      ca_cartes_10,
      ca_cartes_20,
      ca_seances_unitaires,
      ca_frais_inscription,
      ca_personal_training,
      ca_coaching_nutrition,
      ca_suivi_remote,
      ca_cours_specialises,
      ca_competitions_internes,
      ca_competitions_externes,
      ca_seminaires,
      ca_team_building,
      ca_merchandising_vetements,
      ca_merchandising_accessoires,
      ca_complements,
      ca_boissons_snacks,
      ca_sous_location,
      ca_partenariats,
      ca_sponsoring,
      ca_total,
      ca_recurrent,
      ca_non_recurrent,
      pourcent_recurrent
    },
    charges: {
      achats_marchandises,
      variation_stock,
      achats_fournitures,
      loyer_mensuel_ht,
      charges_locatives_mensuelles,
      taxe_fonciere,
      loyer_annuel_total,
      electricite_annuel,
      eau_annuel,
      gaz_chauffage_annuel,
      energies_total,
      entretien_locaux,
      entretien_materiel,
      reparations_exceptionnelles,
      entretien_total,
      assurance_rc_pro,
      assurance_locaux,
      assurance_materiel,
      assurance_prevoyance,
      mutuelle_entreprise,
      assurances_total,
      honoraires_comptable,
      honoraires_avocat,
      cotisations_professionnelles,
      affiliation_crossfit_annuel,
      licences_federales,
      autres_honoraires,
      services_exterieurs_total,
      telephone_internet,
      frais_postaux,
      logiciel_planning,
      logiciel_compta,
      logiciel_crm,
      autres_logiciels,
      site_web_hebergement,
      communication_total,
      google_ads,
      facebook_instagram_ads,
      flyers_affiches,
      marketing_influence,
      sponsoring_events,
      autres_marketing,
      marketing_total,
      salaires_bruts_gerant,
      salaires_bruts_coachs,
      salaires_bruts_administratif,
      charges_sociales_patronales,
      tickets_restaurant,
      formations_salaries,
      medecine_travail,
      charges_freelance,
      autres_charges_personnel,
      masse_salariale_total,
      impots_taxes,
      cfe,
      autres_impots,
      impots_total,
      interets_emprunt,
      agios_bancaires,
      frais_financiers_total,
      amortissements,
      provisions,
      autres_charges_fixes,
      charges_total
    },
    resultat: {
      ebitda,
      ebitda_avant_amortissements,
      marge_ebitda,
      resultat_net,
      marge_nette
    },
    ratios: {
      loyer_ca_ratio,
      ms_ca_ratio,
      marketing_ca_ratio,
      charges_ca_ratio
    }
  };
}

export interface ExtractedMembresData {
  nb_membres_actifs_total: number;
  nb_membres_illimite: number;
  nb_membres_3x_semaine: number;
  nb_membres_2x_semaine: number;
  nb_membres_1x_semaine: number;
  nb_membres_cartes_10: number;
  nb_membres_cartes_20: number;
  nb_membres_hyrox_only: number;
  nb_membres_crossfit_hyrox: number;
  nb_membres_avec_pt: number;
  nb_membres_avec_nutrition: number;
  nb_membres_sans_engagement: number;
  nb_membres_engagement_3m: number;
  nb_membres_engagement_6m: number;
  nb_membres_engagement_12m: number;

  arpm: number;
}

export function extractMembresData(answers: Answer[], financeData: ExtractedFinanceData): ExtractedMembresData {
  const nb_membres_actifs_total = getAnswerValue(answers, 'structure_base', 'nb_membres_actifs_total', 0);
  const nb_membres_illimite = getAnswerValue(answers, 'structure_base', 'nb_membres_illimite', 0);
  const nb_membres_3x_semaine = getAnswerValue(answers, 'structure_base', 'nb_membres_3x_semaine', 0);
  const nb_membres_2x_semaine = getAnswerValue(answers, 'structure_base', 'nb_membres_2x_semaine', 0);
  const nb_membres_1x_semaine = getAnswerValue(answers, 'structure_base', 'nb_membres_1x_semaine', 0);
  const nb_membres_cartes_10 = getAnswerValue(answers, 'structure_base', 'nb_membres_cartes_10', 0);
  const nb_membres_cartes_20 = getAnswerValue(answers, 'structure_base', 'nb_membres_cartes_20', 0);
  const nb_membres_hyrox_only = getAnswerValue(answers, 'structure_base', 'nb_membres_hyrox_only', 0);
  const nb_membres_crossfit_hyrox = getAnswerValue(answers, 'structure_base', 'nb_membres_crossfit_hyrox', 0);
  const nb_membres_avec_pt = getAnswerValue(answers, 'structure_base', 'nb_membres_avec_pt', 0);
  const nb_membres_avec_nutrition = getAnswerValue(answers, 'structure_base', 'nb_membres_avec_nutrition', 0);
  const nb_membres_sans_engagement = getAnswerValue(answers, 'structure_base', 'nb_membres_sans_engagement', 0);
  const nb_membres_engagement_3m = getAnswerValue(answers, 'structure_base', 'nb_membres_engagement_3m', 0);
  const nb_membres_engagement_6m = getAnswerValue(answers, 'structure_base', 'nb_membres_engagement_6m', 0);
  const nb_membres_engagement_12m = getAnswerValue(answers, 'structure_base', 'nb_membres_engagement_12m', 0);

  const arpm = nb_membres_actifs_total > 0 && financeData.revenus.ca_total > 0
    ? financeData.revenus.ca_total / 12 / nb_membres_actifs_total
    : 0;

  return {
    nb_membres_actifs_total,
    nb_membres_illimite,
    nb_membres_3x_semaine,
    nb_membres_2x_semaine,
    nb_membres_1x_semaine,
    nb_membres_cartes_10,
    nb_membres_cartes_20,
    nb_membres_hyrox_only,
    nb_membres_crossfit_hyrox,
    nb_membres_avec_pt,
    nb_membres_avec_nutrition,
    nb_membres_sans_engagement,
    nb_membres_engagement_3m,
    nb_membres_engagement_6m,
    nb_membres_engagement_12m,
    arpm
  };
}

export interface ExtractedOperationsData {
  surface_totale: number;
  surface_crossfit: number;
  ca_par_m2: number;

  taux_occupation_global_pct: number;
  nb_creneaux_semaine: number;
  capacite_max_par_creneau: number;
  participants_moyen_creneau: number;

  nb_essais_gratuits_mois: number;
  nb_conversions_mois: number;
  taux_conversion_pct: number;

  nb_resiliations_mois: number;
  taux_churn_pct: number;
}

export function extractOperationsData(answers: Answer[], financeData: ExtractedFinanceData, membresData: ExtractedMembresData): ExtractedOperationsData {
  const surface_totale = getAnswerValue(answers, 'infrastructure_detaillee', 'surface_totale', 1);
  const surface_crossfit = getAnswerValue(answers, 'infrastructure_detaillee', 'surface_crossfit', 0);
  const ca_par_m2 = surface_totale > 0 && financeData.revenus.ca_total > 0
    ? financeData.revenus.ca_total / surface_totale
    : 0;

  const taux_occupation_global_pct = getAnswerValue(answers, 'capacite_occupation', 'taux_occupation_global_pct', 0);
  const nb_creneaux_semaine = getAnswerValue(answers, 'structure_planning', 'nb_creneaux_semaine', 0);
  const capacite_max_par_creneau = getAnswerValue(answers, 'capacite_occupation', 'capacite_max_par_creneau', 0);
  const participants_moyen_creneau = getAnswerValue(answers, 'capacite_occupation', 'participants_moyen_creneau', 0);

  const nb_essais_gratuits_mois = getAnswerValue(answers, 'acquisition_conversion', 'essais_gratuits_mois', 0);
  const nb_conversions_mois = getAnswerValue(answers, 'acquisition_conversion', 'conversions_essai_abonne_mois', 0);
  const taux_conversion_pct = nb_essais_gratuits_mois > 0
    ? (nb_conversions_mois / nb_essais_gratuits_mois) * 100
    : 0;

  const nb_resiliations_mois = getAnswerValue(answers, 'retention_churn', 'resiliations_mensuelles', 0);
  const taux_churn_pct = membresData.nb_membres_actifs_total > 0
    ? (nb_resiliations_mois / membresData.nb_membres_actifs_total) * 100
    : 0;

  return {
    surface_totale,
    surface_crossfit,
    ca_par_m2,
    taux_occupation_global_pct,
    nb_creneaux_semaine,
    capacite_max_par_creneau,
    participants_moyen_creneau,
    nb_essais_gratuits_mois,
    nb_conversions_mois,
    taux_conversion_pct,
    nb_resiliations_mois,
    taux_churn_pct
  };
}

export interface ExtractedAllData {
  finance: ExtractedFinanceData;
  membres: ExtractedMembresData;
  operations: ExtractedOperationsData;
}

export function extractAllData(answers: Answer[]): ExtractedAllData {
  const finance = extractFinanceData(answers);
  const membres = extractMembresData(answers, finance);
  const operations = extractOperationsData(answers, finance, membres);

  return {
    finance,
    membres,
    operations
  };
}
